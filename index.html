<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>王不亡 - 迴響宇宙</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0a0a1a;
            color: #e0e0e0;
            overflow: hidden;
        }
        #star-map-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            cursor: grab;
        }
        #star-map-container:active { cursor: grabbing; }
        
        .glass-panel {
            background-color: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 召喚祭壇 */
        #summon-altar {
            perspective: 1000px;
        }
        #summon-altar-ring {
            width: 150px; height: 150px;
            border: 3px solid #777; /* 改為中性灰色 */
            border-radius: 50%;
            box-shadow: 0 0 15px #777, inset 0 0 15px #777;
            animation: rotate-altar 20s linear infinite;
            transform-style: preserve-3d;
            transition: all 0.5s ease;
        }
        @keyframes rotate-altar {
            from { transform: rotateY(0deg) rotateX(70deg); }
            to { transform: rotateY(360deg) rotateX(70deg); }
        }

        /* 抽卡動畫 */
        .summoning #summon-altar-ring {
            animation-duration: 0.5s;
        }

        /* 歌曲卡牌 - 低飽和度顏色 */
        .song-card {
            transform-style: preserve-3d;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            position: relative;
        }
        .song-card-album1 { background: linear-gradient(45deg, #283149, #404b69); }
        .song-card-album2 { background: linear-gradient(45deg, #4b3832, #854442); }

        .collection-card { transition: transform 0.2s ease; }
        .collection-card:hover { transform: scale(1.05); }
        .collection-card-album1 { background: linear-gradient(45deg, #283149, #404b69); }
        .collection-card-album2 { background: linear-gradient(45deg, #4b3832, #854442); }
        
        /* 自訂滾動條 */
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        
        /* 皇冠動畫 */
        .crown-light-modal {
            animation: pulse-modal 4s ease-in-out infinite;
        }
        @keyframes pulse-modal {
            0%, 100% { opacity: 0.7; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* 畫面震動特效 */
        .summoning-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* 電流邊框特效 */
        .electric-border {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            filter: url(#electric-filter);
        }

        .electric-border-album1 { --glow-color: #526082; }
        .electric-border-album2 { --glow-color: #be9b7b; }
    </style>
</head>
<body class="antialiased">
    <!-- SVG 濾鏡定義 (for electric border) -->
    <svg class="absolute w-0 h-0">
        <defs>
            <filter id="electric-filter">
                <feTurbulence id="turbulence-filter" type="fractalNoise" baseFrequency="0.01 0.03" numOctaves="3" result="turbulence" seed="0"></feTurbulence>
                <feDisplacementMap id="displacement-map" in="SourceGraphic" in2="turbulence" scale="10" />
            </filter>
        </defs>
    </svg>

    <!-- 背景 -->
    <div id="star-map-container"></div>
    
    <!-- 主要 UI -->
    <main id="main-content" class="fixed inset-0 p-4 flex flex-col items-center justify-between h-full">
        
        <!-- 返回主頁按鈕 -->
        <button id="back-to-home-button"
           class="fixed top-4 right-4 z-50 bg-black/50 backdrop-blur-sm border border-gray-600 text-gray-300 px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-gray-700/70 hover:text-white transition-colors shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
            </svg>
            <span class="hidden sm:inline">返回主頁</span>
        </button>

        <!-- 上方：當前播放區域 -->
        <div id="now-playing-area" class="w-full max-w-sm h-1/3 flex items-center justify-center">
             <div id="card-placeholder" class="text-center text-gray-500">
                <p>點擊下方按鈕</p>
                <p>召喚第一首迴響</p>
            </div>
            <!-- 卡牌會被 JS 插入這裡 -->
        </div>

        <!-- 中間：召喚祭壇 -->
        <div id="summon-altar" class="w-full h-1/3 flex items-center justify-center">
            <div id="summon-altar-ring"></div>
        </div>

        <!-- 下方：控制與收藏區 -->
        <div class="w-full flex flex-col items-center gap-4">
            <button id="summon-btn" class="w-full max-w-sm font-bold text-xl py-4 px-6 bg-amber-600 text-white rounded-lg hover:bg-amber-500 transition-all duration-300 transform hover:scale-105 shadow-lg shadow-amber-500/20">
                召喚迴響
            </button>
             <div id="collection-area" class="w-full glass-panel rounded-lg p-2">
                <div class="flex items-center justify-center mb-2">
                    <button id="about-btn" class="flex items-center gap-2 text-gray-400 hover:text-white transition-colors">
                        <h3 class="text-sm font-semibold text-center">專輯資訊</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="collection-grid" class="flex gap-2 overflow-x-auto custom-scrollbar pb-2">
                    <!-- 收藏的卡牌會被 JS 插入這裡 -->
                </div>
            </div>
        </div>

        <!-- 關於專輯 Modal -->
        <div id="about-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
            <div class="glass-panel rounded-lg shadow-2xl max-w-4xl w-full p-6 sm:p-8 relative">
                <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
                <div class="flex flex-col md:flex-row items-center text-center md:text-left gap-8">
                    <!-- Album 1 Info -->
                    <div class="flex-1 flex flex-col items-center md:items-start">
                        <div class="w-24 h-24 mb-4">
                           <svg class="w-full h-full" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"> <defs> <filter id="glow-modal-1"> <feGaussianBlur stdDeviation="3.5" result="coloredBlur"></feGaussianBlur> <feMerge> <feMergeNode in="coloredBlur"></feMergeNode> <feMergeNode in="SourceGraphic"></feMergeNode> </feMerge> </filter> </defs> <g class="crown-light-modal" filter="url(#glow-modal-1)"> <path d="M 20 80 L 25 40 L 40 55 L 50 30 L 60 55 L 75 40 L 80 80 Z" fill="none" stroke="#E9D5A1" stroke-width="4" stroke-linejoin="round" stroke-linecap="round"/> </g> </svg>
                        </div>
                        <h2 class="text-3xl font-bold text-white">王不亡</h2>
                        <p class="text-lg text-gray-300 mt-1">Wang Bu-Wang</p>
                        <p class="text-base text-gray-400 mt-3">一張探索存在、記憶與虛無的音樂專輯。透過聲音的紋理，我們試圖在縫隙中尋找家園，在廢鐵中看見夢想。</p>
                    </div>
                     <!-- Divider -->
                    <div class="w-full md:w-px h-px md:h-48 bg-gray-700"></div>
                     <!-- Album 2 Info -->
                    <div class="flex-1 flex flex-col items-center md:items-start">
                         <div class="w-24 h-24 mb-4">
                            <svg class="w-full h-full" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"> <defs> <linearGradient id="fireGradient" x1="0%" y1="0%" x2="0%" y2="100%"> <stop offset="0%" style="stop-color:#be9b7b; stop-opacity:1" /> <stop offset="100%" style="stop-color:#854442; stop-opacity:1" /> </linearGradient> <filter id="glow-modal-2"> <feGaussianBlur stdDeviation="3.5" result="coloredBlur"></feGaussianBlur> <feMerge> <feMergeNode in="coloredBlur"></feMergeNode> <feMergeNode in="SourceGraphic"></feMergeNode> </feMerge> </filter> </defs> <g class="crown-light-modal" filter="url(#glow-modal-2)" fill="url(#fireGradient)"> <polygon points="40,30 50,50 30,50" /> <polygon points="50,20 60,30 40,30" /> <polygon points="60,30 70,50 50,50" /> <path d="M25 55 L 45 52 L 48 70 L 30 75 Z" /> <path d="M75 55 L 55 52 L 52 70 L 70 75 Z" /> </g> </svg>
                        </div>
                        <h2 class="text-3xl font-bold text-white">失序花園</h2>
                        <p class="text-lg text-gray-300 mt-1">Disordered Garden</p>
                        <p class="text-base text-gray-400 mt-3">一場關於秩序崩壞與野蠻生長的搖滾寓言。在燃燒的王國廢墟中，尋找狂亂的美感。</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="fixed bottom-1 w-full text-center text-gray-600 text-xs z-10 pointer-events-none">
        <p>© 2025 Wang Bu-Wang. All Rights Reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const songs = [
                // Album 1
                { title: "王不亡", id: "6QqvzkZSwqUW23akhozgg6", album: 1 }, { title: "地板知道", id: "7dVAbcs7Ny68KIClokYorj", album: 1 },
                { title: "縫隙家園", id: "2Q3U5eEMSHH9REaxG601dk", album: 1 }, { title: "廢鐵猿", id: "76enWYcfd8knUKkDFi42ze", album: 1 },
                { title: "雪偏舟", id: "10hfnAE4WpkXfpIX4GVy2B", album: 1 }, { title: "蝦花", id: "1gzwif6jTetRcm5CuxxIPY", album: 1 },
                { title: "我像嗎", id: "2g5Y3yIRRiSootIf9c9rKA", album: 1 }, { title: "Let Light In", id: "4Ci4VGTxwRkHDnnPiyOShz", album: 1 },
                { title: "照完還是空", id: "5EsBs0AdGIhWFQTCswJ1pJ", album: 1 }, { title: "王令開始", id: "4mRstoVpZnLJkweHPJRkbx", album: 1 },
                // Album 2
                { title: "草莓醬臨", id: "2vcbaA88s94ptvlT2lrR3i", album: 2 }, { title: "龍路大主辦", id: "5IsBZXkN3qpR1r2s6YgBx3", album: 2 },
                { title: "八九乘法", id: "27GrIhOTB5GOvZzPUpQnPn", album: 2 }, { title: "總有一頭不見了", id: "3CY9qrRgDm8bjvWVE9ilMU", album: 2 },
                { title: "早苗月之星", id: "0hN9kSd5NbY5cqDUI1GWqQ", album: 2 }, { title: "王瘋了", id: "4I6hIBCh9bL69RyEqi4sME", album: 2 },
                { title: "懷裡的風暴", id: "1Jy1yvkDTes1yJBTKLDF4k", album: 2 }, { title: "尼卡巴卡", id: "0F7bQ0BAd2EqJhUC3RfXaq", album: 2 },
                { title: "彎腰者", id: "2TNIPdXisHtUSP7QeTLlLq", album: 2 }, { title: "七月五日", id: "5KHrFUaoWa6KNSPnU5Y6oc", album: 2 },
                { title: "末秒登車", id: "64KO0oE5VtNu9NO07AYeia", album: 2 }
            ];

            // --- UI 元素 ---
            const nowPlayingArea = document.getElementById('now-playing-area');
            const summonBtn = document.getElementById('summon-btn');
            const collectionGrid = document.getElementById('collection-grid');
            const mainContent = document.getElementById('main-content');
            const aboutBtn = document.getElementById('about-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const aboutModal = document.getElementById('about-modal');
            const altarRing = document.getElementById('summon-altar-ring');
            const backToHomeBtn = document.getElementById('back-to-home-button');
            const turbulenceFilter = document.getElementById('turbulence-filter');
            const displacementMap = document.getElementById('displacement-map');
            
            // --- 狀態管理 ---
            let availableSongs = [...songs];
            let collection = [];
            let isSummoning = false;
            
            // --- 音樂播放 ---
            function playSong(song) {
                const card = document.createElement('div');
                card.className = `song-card rounded-lg shadow-2xl w-full max-w-sm song-card-album${song.album}`;
                card.style.transform = 'rotateY(180deg) scale(0.5)';
                card.innerHTML = `
                    <div class="electric-border electric-border-album${song.album}">
                        <div class="w-full h-full rounded-lg" style="box-shadow: inset 0 0 5px var(--glow-color), 0 0 10px var(--glow-color); border: 2px solid var(--glow-color);"></div>
                    </div>
                    <div class="relative z-10 p-4">
                        <p class="text-2xl font-bold text-white">${song.title}</p>
                        <div class="mt-2 h-[80px] w-full">
                            <iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/${song.id}?utm_source=generator&theme=0&autoplay=1" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
                        </div>
                    </div>
                `;
                nowPlayingArea.innerHTML = '';
                nowPlayingArea.appendChild(card);
                
                setTimeout(() => { card.style.transform = 'rotateY(0deg) scale(1)'; }, 100);
            }

            // --- 召喚邏輯 ---
            summonBtn.addEventListener('click', () => {
                if (isSummoning) return;
                isSummoning = true;
                
                if (availableSongs.length === 0) {
                     summonBtn.textContent = "再次召喚";
                     availableSongs = [...songs];
                     collection = [];
                     collectionGrid.innerHTML = '';
                }

                const randomIndex = Math.floor(Math.random() * availableSongs.length);
                const summonedSong = availableSongs.splice(randomIndex, 1)[0];
                collection.push(summonedSong);
                
                document.getElementById('card-placeholder')?.remove();
                
                const effectColor = summonedSong.album === 1 ? '#526082' : '#be9b7b';
                altarRing.style.borderColor = effectColor;
                altarRing.style.boxShadow = `0 0 20px ${effectColor}, inset 0 0 20px ${effectColor}`;
                
                triggerSummonEffect(new THREE.Color(effectColor));

                setTimeout(() => {
                    playSong(summonedSong);
                    updateCollection();
                    isSummoning = false;
                }, 1000);
            });
            
            // --- 更新收藏庫 UI ---
            function updateCollection() {
                collectionGrid.innerHTML = '';
                collection.forEach(song => {
                    const card = document.createElement('div');
                    card.className = `collection-card rounded p-2 text-center w-20 h-20 flex-shrink-0 flex flex-col justify-center cursor-pointer collection-card-album${song.album}`;
                    card.innerHTML = `<p class="text-xs font-bold leading-tight text-white">${song.title}</p>`;
                    card.addEventListener('click', () => playSong(song));
                    collectionGrid.appendChild(card);
                });
                collectionGrid.scrollLeft = collectionGrid.scrollWidth;
            }
            
            // --- Modal 邏輯 ---
            aboutBtn.addEventListener('click', () => {
                aboutModal.classList.remove('hidden');
                aboutModal.classList.add('flex');
            });
            closeModalBtn.addEventListener('click', () => {
                aboutModal.classList.add('hidden');
                aboutModal.classList.remove('flex');
            });
            aboutModal.addEventListener('click', (e) => {
                if (e.target === aboutModal) {
                    aboutModal.classList.add('hidden');
                    aboutModal.classList.remove('flex');
                }
            });

            // --- 返回主頁邏輯 ---
            backToHomeBtn.addEventListener('click', () => {
                window.parent.postMessage('closeAlbumViewer', '*');
            });

            // --- Three.js 背景 ---
            const bgContainer = document.getElementById('star-map-container');
            let scene, camera, renderer, particles, mouseX = 0, mouseY = 0, isMouseDown = false;
            let shockwave, screenFlash, summonParticles, summonParticlesVelocities;
            const PARTICLE_COUNT = 300;
            
            function initBg() {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 4000);
                camera.position.z = 1000;
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                bgContainer.appendChild(renderer.domElement);
                
                const geometry = new THREE.BufferGeometry();
                const vertices = [];
                for (let i = 0; i < 15000; i++) vertices.push(Math.random() * 3000 - 1500, Math.random() * 3000 - 1500, Math.random() * 3000 - 1500);
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                particles = new THREE.Points(geometry, new THREE.PointsMaterial({ size: 1.5, color: 0xaaaaaa, transparent: true, opacity: 0.7 }));
                scene.add(particles);

                const shockwaveGeo = new THREE.RingGeometry(0.1, 1, 64);
                shockwave = new THREE.Mesh(shockwaveGeo, new THREE.MeshBasicMaterial({ color: 0xf59e0b, transparent: true, opacity: 0 }));
                shockwave.lookAt(new THREE.Vector3(0,0,1));
                scene.add(shockwave);
                
                const summonParticleGeo = new THREE.BufferGeometry();
                const summonParticleVertices = [];
                summonParticlesVelocities = [];
                for (let i = 0; i < PARTICLE_COUNT; i++) {
                    summonParticleVertices.push(0, 0, 1000);
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    const speed = Math.random() * 40 + 20;
                    summonParticlesVelocities.push(new THREE.Vector3(speed * Math.sin(phi) * Math.cos(theta), speed * Math.sin(phi) * Math.sin(theta), speed * Math.cos(phi)));
                }
                summonParticleGeo.setAttribute('position', new THREE.Float32BufferAttribute(summonParticleVertices, 3));
                summonParticles = new THREE.Points(summonParticleGeo, new THREE.PointsMaterial({ size: 4, transparent: true, opacity: 0 }));
                scene.add(summonParticles);

                screenFlash = new THREE.Mesh(new THREE.PlaneGeometry(window.innerWidth * 2, window.innerHeight * 2), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0 }));
                screenFlash.position.z = 500;
                scene.add(screenFlash);

                bgContainer.addEventListener('pointerdown', () => { isMouseDown = true; });
                bgContainer.addEventListener('pointerup', () => { isMouseDown = false; });
                bgContainer.addEventListener('pointermove', (e) => {
                    if (isMouseDown) {
                        mouseX = e.clientX - window.innerWidth / 2;
                        mouseY = e.clientY - window.innerHeight / 2;
                    }
                });
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
            }

            function triggerSummonEffect(color) {
                mainContent.classList.add('summoning-shake');
                setTimeout(() => mainContent.classList.remove('summoning-shake'), 500);

                shockwave.material.color = color;
                shockwave.scale.set(1,1,1);
                shockwave.material.opacity = 1;

                const positions = summonParticles.geometry.attributes.position.array;
                for (let i = 0; i < PARTICLE_COUNT; i++) {
                    positions[i * 3] = 0;
                    positions[i * 3 + 1] = 0;
                    positions[i * 3 + 2] = 0;
                }
                summonParticles.geometry.attributes.position.needsUpdate = true;
                summonParticles.material.color = color;
                summonParticles.material.opacity = 1;

                screenFlash.material.opacity = 0.8;
            }
            
            let electricSeed = 0;
            let electricState = 'calm';
            let burstCounter = 0;

            function animateElectricBorder() {
                if (electricState === 'calm') {
                    electricSeed += 0.02; // 沉穩模式下的緩慢流動
                    displacementMap.setAttribute('scale', 5); // 更低的基礎幅度
                    if (Math.random() < 0.015) { // 觸發暴電的機率
                        electricState = 'burst';
                        burstCounter = 10 + Math.floor(Math.random() * 10); // 暴電持續的影格數
                    }
                } else if (electricState === 'burst') {
                    electricSeed += Math.random() * 5; // 快速變化的種子
                    displacementMap.setAttribute('scale', 30 + Math.random() * 20); // 更離譜的幅度
                    burstCounter--;
                    if (burstCounter <= 0) {
                        electricState = 'calm';
                    }
                }
                turbulenceFilter.setAttribute('seed', electricSeed);
                requestAnimationFrame(animateElectricBorder);
            }


            function animateBg() {
                requestAnimationFrame(animateBg);
                camera.position.x += (mouseX - camera.position.x) * 0.05;
                camera.position.y += (-mouseY - camera.position.y) * 0.05;
                camera.lookAt(scene.position);
                particles.rotation.y += 0.0002;
                
                if (shockwave.material.opacity > 0) {
                    shockwave.scale.x *= 1.12;
                    shockwave.scale.y *= 1.12;
                    shockwave.material.opacity -= 0.04;
                }
                if (summonParticles.material.opacity > 0) {
                    const positions = summonParticles.geometry.attributes.position.array;
                    for (let i = 0; i < PARTICLE_COUNT; i++) {
                        positions[i * 3] += summonParticlesVelocities[i].x;
                        positions[i * 3 + 1] += summonParticlesVelocities[i].y;
                        positions[i * 3 + 2] += summonParticlesVelocities[i].z;
                    }
                    summonParticles.geometry.attributes.position.needsUpdate = true;
                    summonParticles.material.opacity -= 0.02;
                }
                if (screenFlash.material.opacity > 0) {
                    screenFlash.material.opacity -= 0.08;
                }
                
                renderer.render(scene, camera);
            }
            
            initBg();
            animateBg();
            animateElectricBorder();
        });
    </script>
</body>
</html>

